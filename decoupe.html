<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Optimisateur de D√©coupe - Avec Filtre Famille</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #e17055 0%, #d63031 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            padding: 30px;
        }

        .section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            border: 2px solid #e9ecef;
        }

        .section h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.6rem;
            border-bottom: 3px solid #e17055;
            padding-bottom: 10px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #34495e;
        }

        .input-group input,
        .input-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .input-group input:focus,
        .input-group select:focus {
            outline: none;
            border-color: #e17055;
            box-shadow: 0 0 0 3px rgba(225, 112, 85, 0.1);
        }

        .dimensions-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
        }

        .btn {
            background: #e17055;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-top: 15px;
        }

        .btn:hover {
            background: #d63031;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(225, 112, 85, 0.3);
        }

        .btn-success {
            background: #00b894;
        }

        .btn-success:hover {
            background: #00a085;
        }

        .family-filter-section {
            background: #e8f4f8;
            border: 2px solid #74b9ff;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .family-filter-section h3 {
            color: #0984e3;
            margin-bottom: 15px;
            font-size: 1.2rem;
        }

        .family-stats {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
            font-size: 0.9rem;
        }

        .family-stat {
            background: white;
            padding: 8px 12px;
            border-radius: 6px;
            text-align: center;
            border: 1px solid #74b9ff;
        }

        .family-stat .label {
            color: #636e72;
            font-size: 0.8rem;
        }

        .family-stat .value {
            color: #0984e3;
            font-weight: 600;
            font-size: 1rem;
        }

        .stock-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .stock-table th,
        .stock-table td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #ddd;
            font-size: 0.85rem;
        }

        .stock-table th {
            background: #34495e;
            color: white;
            font-weight: 600;
        }

        .stock-table tr:hover {
            background: #f1f2f6;
        }

        .family-cell {
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 4px;
            color: white;
            text-align: center;
            font-size: 0.75rem;
        }

        .family-electrofondus { background: #636e72; }
        .family-silice { background: #74b9ff; }
        .family-zircon-dense { background: #00b894; }
        .family-zircon-mullite { background: #e17055; }
        .family-sillimanite { background: #fdcb6e; color: #2d3436; }
        .family-isolants { background: #a29bfe; }
        .family-divers { background: #fd79a8; }
        .family-40-al2o3 { background: #e84393; }

        .result-section {
            grid-column: 1 / -1;
            margin-top: 20px;
        }

        .results-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-top: 20px;
        }

        .results-left {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .results-right {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .block-3d-container {
            background: white;
            border: 2px solid #ddd;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
        }

        .block-3d-container h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.3rem;
        }

        .combined-scene {
            width: 350px;
            height: 250px;
            margin: 20px auto;
            perspective: 800px;
            perspective-origin: 50% 50%;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            position: relative;
            overflow: visible;
        }

        .combined-box-container {
            width: 100%;
            height: 100%;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.8s ease;
        }

        .block-box {
            position: absolute;
            left: 50%;
            top: 50%;
            transform-style: preserve-3d;
            transition: transform 0.8s ease;
        }

        .block-face {
            position: absolute;
            border: 1px solid rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: white;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
            font-size: 12px;
            backface-visibility: visible;
        }

        .target-face {
            background: rgba(253, 255, 180, 0.9);
            border: 2px solid #e6d73a;
            z-index: 10;
            transition: all 0.3s ease;
            color: #2d3436;
        }

        .target-face:hover {
            background: rgba(253, 255, 180, 1);
            border: 2px solid #d4af37;
            box-shadow: 0 0 10px rgba(230, 215, 58, 0.5);
        }

        .candidate-face {
            background: rgba(116, 185, 255, 0.4);
            border: 1px solid #74b9ff;
            z-index: 5;
            transition: all 0.3s ease;
        }

        .candidate-face:hover {
            background: rgba(116, 185, 255, 0.6);
            border: 1px solid #0984e3;
        }

        .rotation-controls {
            margin-top: 15px;
        }

        .rotation-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 10px;
        }

        .rotation-buttons label {
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 5px;
            transition: background-color 0.3s ease;
            font-size: 0.9rem;
        }

        .rotation-buttons label:hover {
            background-color: #f1f2f6;
        }

        .rotation-buttons input[type="radio"] {
            margin: 0;
        }

        .auto-rotation-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 10px 0;
        }

        .auto-rotation-btn {
            padding: 5px 12px;
            background: #74b9ff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s ease;
        }

        .auto-rotation-btn:hover {
            background: #0984e3;
            transform: translateY(-1px);
        }

        .auto-rotation-btn.active {
            background: #e17055;
        }

        .dimension-tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 5px;
            font-size: 0.8rem;
            pointer-events: none;
            z-index: 1000;
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .dimension-tooltip.show {
            opacity: 1;
        }

        .dimension-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border: 5px solid transparent;
            border-top-color: rgba(0, 0, 0, 0.8);
        }

        .dimensions-info {
            margin-top: 15px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            font-size: 0.85rem;
        }

        .dimension-item {
            background: #f8f9fa;
            padding: 8px;
            border-radius: 5px;
            border-left: 3px solid #ddd;
        }

        .dimension-item.target {
            border-left-color: #00b894;
        }

        .dimension-item.candidate {
            border-left-color: #74b9ff;
        }

        .visualization-legend {
            border-top: 1px solid #ddd;
            padding-top: 10px;
        }

        .cutting-section {
            background: white;
            border: 2px solid #ddd;
            border-radius: 10px;
            padding: 20px;
        }

        .cutting-section h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.3rem;
            border-bottom: 2px solid #e17055;
            padding-bottom: 8px;
        }

        .candidates-section {
            background: white;
            border: 2px solid #ddd;
            border-radius: 10px;
            padding: 20px;
            max-height: 500px;
            overflow-y: auto;
        }

        .candidates-section h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.3rem;
            border-bottom: 2px solid #00b894;
            padding-bottom: 8px;
        }

        .block-perspective {
            position: relative;
            margin: 20px auto;
            perspective: 800px;
            perspective-origin: 50% 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 150px;
        }

        .block-3d {
            position: relative;
            transform-style: preserve-3d;
            animation: rotate3d 8s infinite linear;
        }

        @keyframes rotate3d {
            from { transform: rotateX(15deg) rotateY(0deg); }
            to { transform: rotateX(15deg) rotateY(360deg); }
        }

        .candidate-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            border-left: 4px solid #ddd;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .candidate-item:hover {
            transform: translateX(5px);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            background: #f1f2f6;
        }

        .candidate-item.best {
            border-left-color: #00b894;
            background: linear-gradient(135deg, #e8f5e8 0%, #d1f2eb 100%);
        }

        .candidate-item.selected {
            border: 2px solid #e17055;
            background: linear-gradient(135deg, #fff2f0 0%, #ffe8e4 100%);
            transform: translateX(5px);
            box-shadow: 0 4px 15px rgba(225, 112, 85, 0.3);
        }

        .candidate-item.selected .candidate-ref {
            color: #e17055;
        }

        .candidate-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .candidate-ref {
            font-weight: 600;
            color: #2c3e50;
            font-size: 0.9rem;
        }

        .candidate-score {
            padding: 3px 6px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .score-best {
            background: #00b894;
            color: white;
        }

        .score-good {
            background: #fdcb6e;
            color: #2d3436;
        }

        .candidate-details {
            font-size: 0.8rem;
            color: #636e72;
            line-height: 1.3;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }

        .alert-info {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .alert-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }

        .target-display {
            background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 20px;
        }

        .target-dimensions {
            font-size: 1.8rem;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .target-volume {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .sequence-step {
            background: white;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 10px;
            border-left: 4px solid #ffc107;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .step-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .step-title {
            font-weight: 600;
            color: #2c3e50;
        }

        .step-priority {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
            color: white;
        }

        .priority-haute {
            background: #e74c3c;
        }

        .priority-normale {
            background: #3498db;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .results-container {
                grid-template-columns: 1fr;
            }

            .dimensions-grid {
                grid-template-columns: 1fr;
            }

            .family-stats {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>üîß Optimisateur de D√©coupe</h1>
            <p>Optimisation par famille de mat√©riaux r√©fractaires</p>
        </div>

        <div class="main-content">
            <!-- Section Configuration -->
            <div class="section">
                <h2>üéØ Bloc Cible</h2>

                <div class="input-group">
                    <label>Dimensions Souhait√©es (mm)</label>
                    <div class="dimensions-grid">
                        <div>
                            <label>Longueur</label>
                            <input type="number" id="targetLength" value="1000" min="1">
                        </div>
                        <div>
                            <label>Largeur</label>
                            <input type="number" id="targetWidth" value="500" min="1">
                        </div>
                        <div>
                            <label>√âpaisseur</label>
                            <input type="number" id="targetThickness" value="300" min="1">
                        </div>
                    </div>
                </div>

                <div class="input-group">
                    <label>Crit√®re d'Optimisation</label>
                    <select id="optimizationCriteria">
                        <option value="minWaste">Minimiser les chutes (volume perdu)</option>
                        <option value="minCuts">Minimiser le nombre de d√©coupes</option>
                    </select>
                </div>

                <button class="btn btn-success" onclick="findBestBlock()">
                    üîç Rechercher Meilleur Bloc
                </button>
            </div>

            <!-- Section Stock avec Filtre Famille -->
            <div class="section">
                <h2>üì¶ Inventaire BE Fours</h2>

                <div class="input-group">
                    <label>üìÅ Importer Fichier Stock Excel</label>
                    <input type="file" id="excelFileInput" accept=".xlsx,.xls,.xlsm"
                        style="width: 100%; padding: 8px; border: 2px dashed #e17055; border-radius: 8px; background: #f8f9fa;">
                    <small style="color: #7f8c8d; margin-top: 5px; display: block;">
                        Format: Inventaire BE Fours avec colonnes FAMILLE, CASIER, LONGUEUR, LARGEUR, EPAISSEUR, STOCK
                    </small>
                </div>

                <div style="margin-top: 15px;">
                    <button class="btn" onclick="loadSampleStock()">
                        üìù Charger Exemple R√©fractaires
                    </button>
                </div>

                <!-- Section Filtre par Famille et Qualit√© -->
                <div class="family-filter-section" id="familyFilterSection" style="display: none;">
                    <h3>üè∑Ô∏è Filtrer par Famille et Qualit√©</h3>
                    
                    <div class="input-group">
                        <label>Famille S√©lectionn√©e</label>
                        <select id="familyFilter" onchange="filterByFamilyAndQuality()">
                            <option value="all">üåê Toutes les familles</option>
                        </select>
                    </div>

                    <div class="input-group">
                        <label>Qualit√© S√©lectionn√©e</label>
                        <select id="qualityFilter" onchange="filterByFamilyAndQuality()">
                            <option value="all">üåü Toutes les qualit√©s</option>
                        </select>
                    </div>

                    <div class="family-stats" id="familyStats">
                        <div class="family-stat">
                            <div class="label">Blocs disponibles</div>
                            <div class="value" id="availableBlocks">0</div>
                        </div>
                        <div class="family-stat">
                            <div class="label">Stock total</div>
                            <div class="value" id="totalStock">0</div>
                        </div>
                        <div class="family-stat">
                            <div class="label">Qualit√©s</div>
                            <div class="value" id="qualityCount">0</div>
                        </div>
                    </div>
                </div>

                <div id="importStatus" style="margin-top: 10px; padding: 10px; border-radius: 5px; display: none;">
                </div>

                <div style="max-height: 350px; overflow-y: auto; margin-top: 15px;">
                    <table class="stock-table" id="stockTable">
                        <thead>
                            <tr>
                                <th>Famille</th>
                                <th>Qualit√©</th>
                                <th>Casier</th>
                                <th>L (mm)</th>
                                <th>l (mm)</th>
                                <th>√âp. (mm)</th>
                                <th>Stock</th>
                            </tr>
                        </thead>
                        <tbody id="stockTableBody">
                            <tr>
                                <td colspan="7" style="text-align: center; color: #7f8c8d; padding: 30px;">
                                    üìÅ Importez votre fichier Excel ou cliquez sur "Charger Exemple"
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Section R√©sultats -->
        <div class="section result-section" id="resultsSection" style="display: none;">
            <h2>üéØ R√©sultats d'optimisation</h2>

            <div class="target-display" id="targetDisplay">
                <div class="target-dimensions">1000 √ó 500 √ó 300 mm</div>
                <div class="target-volume">Volume cible : 150 000 000 mm¬≥</div>
            </div>

            <div class="alert alert-info" id="optimizationStatus">
                Recherche en cours...
            </div>

            <div style="text-align: center; margin: 20px 0;">
                <button class="btn" onclick="exportToPDF()" id="exportPDFBtn" style="display: none;">
                    üìÑ Exporter Fiche de D√©coupe PDF
                </button>
            </div>

            <div class="results-container">
                <div class="results-left">
                    <div class="block-3d-container">
                        <h3>üì¶ Visualisation Comparative</h3>
                        <div id="combinedBlockViz">
                            <!-- Sera rempli par JS -->
                        </div>
                        
                        <!-- Contr√¥les de rotation -->
                        <div class="rotation-controls" id="rotationControls" style="display: none;">
                            <div style="margin: 15px 0; text-align: center;">
                                <strong>Vue 3D :</strong>
                            </div>
                            <div class="rotation-buttons">
                                <label><input type="radio" name="rotate-view" value="front" checked> Face</label>
                                <label><input type="radio" name="rotate-view" value="right"> Droite</label>
                                <label><input type="radio" name="rotate-view" value="top"> Dessus</label>
                                <label><input type="radio" name="rotate-view" value="perspective"> 3D</label>
                            </div>
                        </div>
                        
                        <!-- L√©gende -->
                        <div class="visualization-legend" id="vizLegend" style="display: none;">
                            <div style="display: flex; justify-content: center; gap: 20px; margin-top: 10px; font-size: 0.85rem;">
                                <div style="display: flex; align-items: center; gap: 5px;">
                                    <div style="width: 15px; height: 15px; background: #fdffb4; border: 1px solid #e6d73a; border-radius: 3px;"></div>
                                    <span>Bloc cible</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 5px;">
                                    <div style="width: 15px; height: 15px; background: rgba(116, 185, 255, 0.4); border: 1px solid #74b9ff; border-radius: 3px;"></div>
                                    <span>Bloc candidat</span>
                                </div>
                            </div>
                            <div style="text-align: center; margin-top: 8px; font-size: 0.75rem; color: #636e72;">
                                üí° Survolez les faces pour voir les dimensions
                            </div>
                        </div>
                    </div>
                </div>

                <div class="results-right">
                    <div class="cutting-section">
                        <h3>‚úÇÔ∏è D√©coupes √† r√©aliser</h3>
                        <div id="cuttingDetails"></div>
                    </div>

                    <div class="candidates-section">
                        <h3>üèÜ Candidats d√©coupe</h3>
                        <div id="candidatesList"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let stockData = [];
        let allStockData = [];
        let optimizationResult = null;
        let selectedCandidateIndex = 0;
        
        // Variables pour rotation continue et mesures interactives
        let autoRotationInterval = null;
        let currentRotationAngle = 0;
        let currentTargetDimensions = null;
        let currentCandidateBlock = null;

        // Couleurs par famille de mat√©riaux r√©fractaires
        const familyColors = {
            'ELECTROFONDUS': 'family-electrofondus',
            'SILICE': 'family-silice',
            'ZIRCON DENSE': 'family-zircon-dense',
            'ZIRCON MULLITE': 'family-zircon-mullite',
            'SILLIMANITE': 'family-sillimanite',
            'ISOLANTS': 'family-isolants',
            'DIVERS': 'family-divers',
            '40% AL2O3': 'family-40-al2o3'
        };

        // Traitement du fichier Excel adapt√© √† votre format
        async function handleExcelFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            const statusDiv = document.getElementById('importStatus');
            statusDiv.style.display = 'block';
            statusDiv.className = 'alert alert-info';
            statusDiv.innerHTML = `üì• Lecture du fichier "${file.name}" en cours...`;

            try {
                const arrayBuffer = await file.arrayBuffer();
                const workbook = XLSX.read(arrayBuffer, {
                    type: 'array',
                    cellText: false,
                    cellDates: true,
                    cellStyles: false
                });

                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];

                if (!worksheet) {
                    throw new Error('Aucune feuille de calcul trouv√©e dans le fichier');
                }

                const jsonData = XLSX.utils.sheet_to_json(worksheet, {
                    header: 1,
                    defval: '',
                    blankrows: false
                });

                if (jsonData.length === 0) {
                    throw new Error('Le fichier Excel semble vide');
                }

                const parsedStock = parseInventaireBEFours(jsonData);

                if (parsedStock.length === 0) {
                    throw new Error('Aucune donn√©e valide trouv√©e');
                }

                allStockData = parsedStock;
                stockData = parsedStock;

                setupFamilyFilter();
                updateStockTable();

                statusDiv.className = 'alert alert-info';
                statusDiv.innerHTML = `‚úÖ Import r√©ussi ! ${parsedStock.length} casiers charg√©s avec ${getUniqueFamilies().length} familles`;

            } catch (error) {
                console.error('‚ùå Erreur import Excel:', error);
                statusDiv.className = 'alert alert-warning';
                statusDiv.innerHTML = `‚ùå Erreur lors de l'import: ${error.message}`;
            }
        }

        // Parser sp√©cifique pour le format "Inventaire BE Fours" avec support qualit√©
        function parseInventaireBEFours(jsonData) {
            if (jsonData.length < 5) {
                throw new Error('Fichier trop court - format Inventaire BE Fours attendu');
            }

            // Les en-t√™tes sont √† la ligne 3 (index 2)
            const headerRowIndex = 2;
            const headers = jsonData[headerRowIndex];

            if (!headers || headers.length < 11) {
                throw new Error('En-t√™tes non trouv√©s √† la ligne 3');
            }

            // Mapping des colonnes selon votre format exact avec QUALIT√â
            const columnIndices = {
                famille: 1,     // Colonne B: FAMILLE
                casier: 3,      // Colonne D: CASIER  
                longueur: 6,    // Colonne G: LONGUEUR
                largeur: 7,     // Colonne H: LARGEUR
                epaisseur: 8,   // Colonne I: EPAISSEUR
                qualite: 10,    // Colonne K: QUALIT√â
                stock: 11       // Colonne L: STOCK
            };

            const parsedData = [];
            
            // Commencer √† la ligne 4 (index 3) - apr√®s les en-t√™tes
            for (let i = 3; i < jsonData.length; i++) {
                const row = jsonData[i];
                if (!row || row.length === 0) continue;

                try {
                    const famille = String(row[columnIndices.famille] || '').trim().toUpperCase();
                    const casier = String(row[columnIndices.casier] || '').trim();
                    const qualite = String(row[columnIndices.qualite] || 'Non d√©fini').trim();
                    
                    // Parsing des dimensions num√©riques
                    const longueur = parseFloat(String(row[columnIndices.longueur] || '0').replace(',', '.')) || 0;
                    const largeur = parseFloat(String(row[columnIndices.largeur] || '0').replace(',', '.')) || 0;
                    const epaisseur = parseFloat(String(row[columnIndices.epaisseur] || '0').replace(',', '.')) || 0;
                    
                    // Parsing du stock (format "10 PC" -> 10)
                    let stock = 0;
                    const stockStr = String(row[columnIndices.stock] || '0');
                    const stockMatch = stockStr.match(/(\d+(?:[\.,]\d+)?)/);
                    if (stockMatch) {
                        stock = parseInt(stockMatch[1].replace(',', '.'));
                    }

                    // Filtrer les lignes valides
                    if (!famille || !casier || longueur <= 0 || largeur <= 0 || epaisseur <= 0) {
                        continue;
                    }

                    parsedData.push({
                        ref: casier,
                        length: longueur,
                        width: largeur,
                        thickness: epaisseur,
                        quantity: stock,
                        family: famille,
                        quality: qualite
                    });

                } catch (error) {
                    console.log(`‚ö†Ô∏è Erreur ligne ${i + 1}:`, error.message);
                }
            }

            return parsedData;
        }

        function getUniqueFamilies() {
            const families = [...new Set(allStockData.map(item => item.family))];
            return families.sort();
        }

        function getUniqueQualities() {
            const qualities = [...new Set(allStockData.map(item => item.quality))];
            return qualities.sort();
        }

        function setupFamilyFilter() {
            const families = getUniqueFamilies();
            const qualities = getUniqueQualities();
            const familyFilter = document.getElementById('familyFilter');
            const qualityFilter = document.getElementById('qualityFilter');
            const familySection = document.getElementById('familyFilterSection');

            familyFilter.innerHTML = '<option value="all">üåê Toutes les familles</option>';
            qualityFilter.innerHTML = '<option value="all">üåü Toutes les qualit√©s</option>';

            families.forEach(family => {
                const option = document.createElement('option');
                option.value = family;
                
                const familyIcons = {
                    'ELECTROFONDUS': '‚ö°',
                    'SILICE': 'üßä',
                    'ZIRCON DENSE': 'üíé',
                    'ZIRCON MULLITE': 'üî∑',
                    'SILLIMANITE': 'üóø',
                    'ISOLANTS': 'üõ°Ô∏è',
                    'DIVERS': 'üì¶',
                    '40% AL2O3': 'üß±'
                };
                
                const icon = familyIcons[family] || 'üìã';
                option.textContent = `${icon} ${family}`;
                familyFilter.appendChild(option);
            });

            qualities.forEach(quality => {
                const option = document.createElement('option');
                option.value = quality;
                
                const qualityIcons = {
                    'AZS 33% RC': 'üíé',
                    'AZS 33% VF': 'üí†',
                    'AZS 41% VF': 'üî∑',
                    'Non d√©fini': '‚ùì',
                    'Jargal': 'üî∂',
                    '95% ZrO2': 'üíç',
                    'ER 1682 RX': 'üîπ',
                    'ER 5312 RX': 'üü¶',
                    'ZM30%': 'üîµ',
                    'ZM20%': 'üü£',
                    '>99% Al2O3': '‚ö™',
                    '60% Al2O3': 'üîò',
                    '40/42% Al2O3': '‚ö´',
                    '35% Al2O3': 'üü§',
                    'MgO > 95%': 'üü¢',
                    'MgO 85-90%': 'üü©',
                    'MgO 70-75%': 'üíö',
                    'MgO 50-60%': 'üåø',
                    'SiO2 99%': '‚ùÑÔ∏è',
                    'SiO2 95%': 'üßä'
                };
                
                const icon = qualityIcons[quality] || '‚≠ê';
                option.textContent = `${icon} ${quality}`;
                qualityFilter.appendChild(option);
            });

            familySection.style.display = 'block';
            updateFamilyStats();
        }

        function filterByFamilyAndQuality() {
            const selectedFamily = document.getElementById('familyFilter').value;
            const selectedQuality = document.getElementById('qualityFilter').value;
            
            stockData = allStockData.filter(item => {
                const familyMatch = selectedFamily === 'all' || item.family === selectedFamily;
                const qualityMatch = selectedQuality === 'all' || item.quality === selectedQuality;
                return familyMatch && qualityMatch;
            });
            
            updateStockTable();
            updateFamilyStats();
        }

        function updateFamilyStats() {
            const selectedFamily = document.getElementById('familyFilter').value;
            const selectedQuality = document.getElementById('qualityFilter').value;
            let dataToAnalyze = stockData;
            
            const availableBlocks = dataToAnalyze.filter(item => item.quantity > 0).length;
            const totalStock = dataToAnalyze.reduce((sum, item) => sum + item.quantity, 0);
            
            // Compter les qualit√©s uniques dans les donn√©es filtr√©es
            const uniqueQualities = [...new Set(dataToAnalyze.map(item => item.quality))];
            const qualityCount = uniqueQualities.length;
            
            document.getElementById('availableBlocks').textContent = availableBlocks;
            document.getElementById('totalStock').textContent = totalStock;
            document.getElementById('qualityCount').textContent = qualityCount;
        }

        function updateStockTable() {
            const tbody = document.getElementById('stockTableBody');
            tbody.innerHTML = '';

            if (stockData.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td colspan="7" style="text-align: center; color: #7f8c8d; padding: 30px;">
                        üìÅ Aucune donn√©e √† afficher
                    </td>
                `;
                tbody.appendChild(row);
                return;
            }

            stockData.forEach(block => {
                const row = document.createElement('tr');
                const familyClass = familyColors[block.family] || 'family-divers';
                
                // Couleur pour la qualit√©
                const qualityClass = block.quality === 'Non d√©fini' ? 'style="color: #e74c3c; font-style: italic;"' : 'style="color: #27ae60; font-weight: 600;"';
                
                row.innerHTML = `
                    <td><span class="family-cell ${familyClass}">${block.family}</span></td>
                    <td ${qualityClass}>${block.quality}</td>
                    <td style="font-weight: 600; color: #e17055; font-size: 0.8rem;">${block.ref}</td>
                    <td>${block.length}</td>
                    <td>${block.width}</td>
                    <td>${block.thickness}</td>
                    <td style="font-weight: 600; color: #00b894;">${block.quantity}</td>
                `;
                tbody.appendChild(row);
            });

            const summaryRow = document.createElement('tr');
            summaryRow.style.background = '#f8f9fa';
            summaryRow.style.fontWeight = '600';
            const totalStock = stockData.reduce((sum, item) => sum + item.quantity, 0);
            summaryRow.innerHTML = `
                <td colspan="6" style="text-align: right; color: #2c3e50;">TOTAL :</td>
                <td style="color: #e74c3c;">${totalStock} pcs</td>
            `;
            tbody.appendChild(summaryRow);
        }

        function loadSampleStock() {
            allStockData = [
                // Famille ELECTROFONDUS avec diff√©rentes qualit√©s √©lectrofondus
                {ref: "PFI_023DA_000", length: 1500, width: 300, thickness: 412, quantity: 10, family: "ELECTROFONDUS", quality: "AZS 33% RC"},
                {ref: "PFI_04X5A_000", length: 890, width: 400, thickness: 250, quantity: 1, family: "ELECTROFONDUS", quality: "AZS 33% VF"},
                {ref: "PFI_05B2A_000", length: 1200, width: 350, thickness: 380, quantity: 3, family: "ELECTROFONDUS", quality: "AZS 41% VF"},
                {ref: "PFI_06C3A_000", length: 800, width: 300, thickness: 250, quantity: 5, family: "ELECTROFONDUS", quality: "95% ZrO2"},
                {ref: "PFI_07D4A_000", length: 950, width: 280, thickness: 320, quantity: 2, family: "ELECTROFONDUS", quality: "ER 1682 RX"},
                {ref: "PFI_08E5A_000", length: 750, width: 250, thickness: 200, quantity: 4, family: "ELECTROFONDUS", quality: "ER 5312 RX"},
                {ref: "PFI_09F6A_000", length: 600, width: 300, thickness: 150, quantity: 1, family: "ELECTROFONDUS", quality: "Jargal"},
                
                // Famille ZIRCON DENSE/MULLITE avec qualit√©s zircon
                {ref: "ZDN_700C_000", length: 1400, width: 700, thickness: 400, quantity: 3, family: "ZIRCON DENSE", quality: "ZM30%"},
                {ref: "ZMT_550D_001", length: 1100, width: 550, thickness: 320, quantity: 4, family: "ZIRCON MULLITE", quality: "ZM20%"},
                
                // Famille SILLIMANITE avec qualit√©s silico-alumineux
                {ref: "SLM_400E_000", length: 950, width: 480, thickness: 310, quantity: 6, family: "SILLIMANITE", quality: ">99% Al2O3"},
                {ref: "SLM_401E_000", length: 850, width: 420, thickness: 280, quantity: 8, family: "SILLIMANITE", quality: "60% Al2O3"},
                {ref: "SLM_402E_000", length: 750, width: 380, thickness: 250, quantity: 5, family: "SILLIMANITE", quality: "40/42% Al2O3"},
                {ref: "SLM_403E_000", length: 650, width: 340, thickness: 220, quantity: 7, family: "SILLIMANITE", quality: "35% Al2O3"},
                
                // Famille DIVERS avec qualit√©s magn√©sie
                {ref: "DIV_600G_000", length: 1300, width: 650, thickness: 380, quantity: 2, family: "DIVERS", quality: "MgO > 95%"},
                {ref: "DIV_601G_000", length: 1100, width: 550, thickness: 320, quantity: 3, family: "DIVERS", quality: "MgO 85-90%"},
                {ref: "DIV_602G_000", length: 900, width: 450, thickness: 280, quantity: 4, family: "DIVERS", quality: "MgO 70-75%"},
                {ref: "DIV_603G_000", length: 700, width: 350, thickness: 240, quantity: 6, family: "DIVERS", quality: "MgO 50-60%"},
                
                // Famille SILICE avec qualit√©s silice
                {ref: "SIL_450B_001", length: 1200, width: 600, thickness: 350, quantity: 5, family: "SILICE", quality: "SiO2 99%"},
                {ref: "SIL_300A_002", length: 1000, width: 500, thickness: 300, quantity: 8, family: "SILICE", quality: "SiO2 95%"},
                
                // Famille ISOLANTS avec quelques qualit√©s mixtes
                {ref: "ISO_250F_001", length: 800, width: 400, thickness: 250, quantity: 12, family: "ISOLANTS", quality: "Non d√©fini"},
                {ref: "AL2_350H_001", length: 900, width: 450, thickness: 280, quantity: 7, family: "40% AL2O3", quality: "Non d√©fini"}
            ];
            
            stockData = allStockData;
            setupFamilyFilter();
            updateStockTable();

            const statusDiv = document.getElementById('importStatus');
            statusDiv.style.display = 'block';
            statusDiv.className = 'alert alert-info';
            statusDiv.innerHTML = '‚úÖ Exemple enrichi charg√© ! 21 types de r√©fractaires avec 8 familles et 18 qualit√©s sp√©cialis√©es.';
        }

        function findBestBlock() {
            const targetLength = parseInt(document.getElementById('targetLength').value);
            const targetWidth = parseInt(document.getElementById('targetWidth').value);
            const targetThickness = parseInt(document.getElementById('targetThickness').value);
            const criteria = document.getElementById('optimizationCriteria').value;

            if (stockData.length === 0) {
                alert('Veuillez d\'abord charger un inventaire !');
                return;
            }

            if (targetLength <= 0 || targetWidth <= 0 || targetThickness <= 0) {
                alert('Veuillez saisir des dimensions valides !');
                return;
            }

            document.getElementById('resultsSection').style.display = 'block';
            document.getElementById('optimizationStatus').textContent = 'Analyse des candidats en cours...';

            updateTargetDisplay(targetLength, targetWidth, targetThickness);

            setTimeout(() => {
                const result = analyzeBlocks(targetLength, targetWidth, targetThickness, criteria);
                displayResults(result, targetLength, targetWidth, targetThickness);
            }, 500);
        }

        function analyzeBlocks(targetL, targetW, targetT, criteria) {
            console.log(`üéØ RECHERCHE: ${targetL}√ó${targetW}√ó${targetT}mm`);
            console.log(`üì¶ Stock disponible: ${stockData.length} types`);

            const targetVolume = targetL * targetW * targetT;
            const candidates = [];

            stockData.forEach(block => {
                if (block.quantity <= 0) return;

                if (block.length >= targetL && block.width >= targetW && block.thickness >= targetT) {
                    const analysis = analyzeBlock(block, targetL, targetW, targetT);
                    candidates.push({
                        block: block,
                        analysis: analysis,
                        score: calculateScore(analysis, criteria)
                    });
                }
            });

            candidates.sort((a, b) => a.score - b.score);

            console.log(`‚úÖ ${candidates.length} candidats trouv√©s`);

            return {
                candidates: candidates,
                targetVolume: targetVolume,
                criteria: criteria
            };
        }

        function analyzeBlock(block, targetL, targetW, targetT) {
            const piecesL = Math.floor(block.length / targetL);
            const piecesW = Math.floor(block.width / targetW);
            const piecesT = Math.floor(block.thickness / targetT);
            
            const totalPieces = piecesL * piecesW * piecesT;
            
            const usedVolume = totalPieces * (targetL * targetW * targetT);
            const blockVolume = block.length * block.width * block.thickness;
            const wasteVolume = blockVolume - usedVolume;
            
            let cuts = 0;
            
            if (block.length > targetL) cuts++; 
            if (block.width > targetW) cuts++; 
            if (block.thickness > targetT) cuts++; 
            
            if (piecesL > 1) cuts += (piecesL - 1); 
            if (piecesW > 1) cuts += (piecesW - 1); 
            if (piecesT > 1) cuts += (piecesT - 1); 
            
            const lengthWaste = block.length - (piecesL * targetL);
            const widthWaste = block.width - (piecesW * targetW);
            const thicknessWaste = block.thickness - (piecesT * targetT);

            return {
                cuts: cuts,
                wasteVolume: wasteVolume,
                wastePercent: (wasteVolume / blockVolume) * 100,
                lengthWaste: lengthWaste,
                widthWaste: widthWaste,
                thicknessWaste: thicknessWaste,
                efficiency: (usedVolume / blockVolume) * 100,
                totalPieces: totalPieces,
                piecesL: piecesL,
                piecesW: piecesW,
                piecesT: piecesT,
                usedVolume: usedVolume,
                arrangement: `${piecesL}√ó${piecesW}√ó${piecesT}`,
                wastePerPiece: totalPieces > 0 ? wasteVolume / totalPieces : wasteVolume,
                needsCutL: block.length > targetL,
                needsCutW: block.width > targetW,
                needsCutT: block.thickness > targetT
            };
        }

        function calculateScore(analysis, criteria) {
            switch (criteria) {
                case 'minWaste':
                    return analysis.totalPieces > 0 ? analysis.wastePerPiece : analysis.wasteVolume;
                case 'minCuts':
                    const cutsPerPiece = analysis.totalPieces > 0 ? analysis.cuts / analysis.totalPieces : analysis.cuts;
                    return cutsPerPiece * 1000000 + analysis.wastePerPiece;
                default:
                    return analysis.wastePerPiece;
            }
        }

        function updateTargetDisplay(length, width, thickness) {
            const volume = length * width * thickness;
            document.getElementById('targetDisplay').innerHTML = `
                <div class="target-dimensions">${length} √ó ${width} √ó ${thickness} mm</div>
                <div class="target-volume">Volume cible : ${volume.toLocaleString()} mm¬≥</div>
            `;
        }

        function displayResults(result, targetL, targetW, targetT) {
            if (!result || !result.candidates || result.candidates.length === 0) {
                document.getElementById('optimizationStatus').textContent = 'Aucun bloc compatible trouv√© dans l\'inventaire !';
                document.getElementById('optimizationStatus').className = 'alert alert-warning';
                document.getElementById('exportPDFBtn').style.display = 'none';

                clearVisualization('combinedBlockViz');
                clearVisualization('cuttingDetails');
                document.getElementById('candidatesList').innerHTML = '<div style="text-align: center; color: #7f8c8d; padding: 30px;">Aucun candidat disponible</div>';
                return;
            }

            selectedCandidateIndex = 0;
            const bestCandidate = result.candidates[0];
            
            document.getElementById('optimizationStatus').innerHTML = `
                ‚úÖ ${result.candidates.length} candidat(s) trouv√©(s) ! 
                Meilleur choix : <strong>${bestCandidate.block.ref}</strong> (${bestCandidate.block.family})
            `;
            document.getElementById('optimizationStatus').className = 'alert alert-info';

            document.getElementById('exportPDFBtn').style.display = 'inline-block';

            visualizeCombinedBlocks({length: targetL, width: targetW, thickness: targetT}, null);
            
            updateSelectedCandidate(targetL, targetW, targetT);

            displayCandidatesList(result.candidates, result.criteria);

            optimizationResult = result;
        }

        function updateSelectedCandidate(targetL, targetW, targetT) {
            if (!optimizationResult || !optimizationResult.candidates || optimizationResult.candidates.length === 0) {
                return;
            }

            const selectedCandidate = optimizationResult.candidates[selectedCandidateIndex];
            
            visualizeCombinedBlocks(
                {length: targetL, width: targetW, thickness: targetT}, 
                selectedCandidate.block
            );

            displayCuttingDetailsSimplified(selectedCandidate.block, targetL, targetW, targetT, selectedCandidate.analysis);

            const statusDiv = document.getElementById('optimizationStatus');
            if (selectedCandidateIndex === 0) {
                statusDiv.innerHTML = `
                    ‚úÖ ${optimizationResult.candidates.length} candidat(s) trouv√©(s) ! 
                    Meilleur choix : <strong>${selectedCandidate.block.ref}</strong> (${selectedCandidate.block.family})
                `;
            } else {
                statusDiv.innerHTML = `
                    ‚úÖ ${optimizationResult.candidates.length} candidat(s) trouv√©(s) ! 
                    Candidat s√©lectionn√© : <strong>${selectedCandidate.block.ref}</strong> (${selectedCandidate.block.family}) - Rang #${selectedCandidateIndex + 1}
                `;
            }
        }

        function selectCandidate(index) {
            if (!optimizationResult || !optimizationResult.candidates || index >= optimizationResult.candidates.length) {
                return;
            }

            selectedCandidateIndex = index;
            
            const targetL = parseInt(document.getElementById('targetLength').value);
            const targetW = parseInt(document.getElementById('targetWidth').value);
            const targetT = parseInt(document.getElementById('targetThickness').value);
            
            updateSelectedCandidate(targetL, targetW, targetT);
            
            updateCandidateSelection();
        }

        function updateCandidateSelection() {
            const candidateItems = document.querySelectorAll('.candidate-item');
            candidateItems.forEach((item, index) => {
                item.classList.remove('selected');
                if (index === selectedCandidateIndex) {
                    item.classList.add('selected');
                }
            });
        }

        function displayCuttingDetailsSimplified(originalBlock, targetL, targetW, targetT, analysis) {
            const container = document.getElementById('cuttingDetails');
            if (!container) return;

            container.innerHTML = '';

            const summaryDiv = document.createElement('div');
            summaryDiv.style.cssText = 'background: #e8f5e8; padding: 15px; border-radius: 8px; margin-bottom: 15px; text-align: center; border: 2px solid #00b894;';
            
            if (analysis.totalPieces > 1) {
                summaryDiv.innerHTML = `
                    <strong>üéØ Production Multi-Pi√®ces</strong><br>
                    <div style="font-size: 1.2rem; font-weight: 600; color: #00b894; margin: 5px 0;">
                        ${analysis.totalPieces} pi√®ces (${analysis.arrangement})
                    </div>
                    <small>D√©coupes totales: ${analysis.cuts} | Chutes: ${analysis.wasteVolume.toLocaleString()} mm¬≥</small>
                `;
            } else {
                summaryDiv.innerHTML = `
                    <strong>üéØ Production Pi√®ce Unique</strong><br>
                    <small>D√©coupes: ${analysis.cuts} | Chutes: ${analysis.wasteVolume.toLocaleString()} mm¬≥</small>
                `;
            }
            container.appendChild(summaryDiv);

            const cuttingPlan = [];
            
            if (analysis.needsCutL) {
                cuttingPlan.push({
                    dimension: 'Longueur',
                    pieces: analysis.piecesL,
                    pieceSize: targetL,
                    blockSize: originalBlock.length,
                    waste: analysis.lengthWaste,
                    cuts: analysis.piecesL > 1 ? analysis.piecesL - 1 : 1
                });
            }
            
            if (analysis.needsCutW) {
                cuttingPlan.push({
                    dimension: 'Largeur', 
                    pieces: analysis.piecesW,
                    pieceSize: targetW,
                    blockSize: originalBlock.width,
                    waste: analysis.widthWaste,
                    cuts: analysis.piecesW > 1 ? analysis.piecesW - 1 : 1
                });
            }
            
            if (analysis.needsCutT) {
                cuttingPlan.push({
                    dimension: '√âpaisseur',
                    pieces: analysis.piecesT,
                    pieceSize: targetT,
                    blockSize: originalBlock.thickness,
                    waste: analysis.thicknessWaste,
                    cuts: analysis.piecesT > 1 ? analysis.piecesT - 1 : 1
                });
            }

            if (cuttingPlan.length === 0) {
                container.innerHTML += `
                    <div style="text-align: center; color: #00b894; padding: 30px;">
                        <strong>‚úÖ Aucune d√©coupe n√©cessaire</strong><br>
                        <small>Les dimensions correspondent exactement</small>
                    </div>
                `;
                return;
            }

            const sequenceDiv = document.createElement('div');
            sequenceDiv.innerHTML = '<h4 style="color: #2c3e50; margin-bottom: 15px;">üìã S√©quence optimale de d√©coupe</h4>';
            
            cuttingPlan.sort((a, b) => b.pieces - a.pieces);
            
            cuttingPlan.forEach((plan, index) => {
                const stepDiv = document.createElement('div');
                stepDiv.className = 'sequence-step';
                
                const isMultiCut = plan.pieces > 1;
                const stepTitle = `√âtape ${index + 1}: ${plan.dimension}`;
                const priority = isMultiCut ? 'HAUTE' : 'NORMALE';
                
                stepDiv.innerHTML = `
                    <div class="step-header">
                        <span class="step-title">${stepTitle}</span>
                        <span class="step-priority ${priority === 'HAUTE' ? 'priority-haute' : 'priority-normale'}">${priority}</span>
                    </div>
                    <div style="font-size: 0.9rem; color: #2c3e50; margin-bottom: 6px;">
                        üìè ${plan.blockSize}mm ‚Üí ${isMultiCut ? `${plan.pieces} √ó ${plan.pieceSize}mm` : `${plan.pieceSize}mm`}
                    </div>
                    <div style="font-size: 0.85rem; color: #636e72;">
                        ‚úÇÔ∏è ${plan.cuts} d√©coupe(s) | üìê Chute: ${plan.waste}mm
                    </div>
                `;
                
                sequenceDiv.appendChild(stepDiv);
            });
            
            container.appendChild(sequenceDiv);

            const finalDiv = document.createElement('div');
            finalDiv.style.cssText = 'background: #d1f2eb; padding: 15px; border-radius: 8px; margin-top: 15px; text-align: center; border: 2px solid #00b894;';
            finalDiv.innerHTML = `
                <strong>üéØ Production finale</strong><br>
                <div style="font-family: 'Courier New', monospace; font-weight: 600; margin: 8px 0; font-size: 1.1rem;">
                    ${analysis.totalPieces} √ó (${targetL} √ó ${targetW} √ó ${targetT} mm)
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; font-size: 0.9rem;">
                    <div>Volume utile: ${analysis.usedVolume.toLocaleString()} mm¬≥</div>
                    <div>Efficacit√©: ${analysis.efficiency.toFixed(1)}%</div>
                </div>
            `;
            container.appendChild(finalDiv);
        }

        function clearVisualization(containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;
            container.innerHTML = '<div style="text-align: center; color: #7f8c8d; padding: 30px;">Aucun bloc √† afficher</div>';
            
            document.getElementById('rotationControls').style.display = 'none';
            document.getElementById('vizLegend').style.display = 'none';
        }

        function visualizeCombinedBlocks(targetDimensions, candidateBlock) {
            const container = document.getElementById('combinedBlockViz');
            if (!container) return;

            currentTargetDimensions = targetDimensions;
            currentCandidateBlock = candidateBlock;

            container.innerHTML = '';

            let maxDim = Math.max(targetDimensions.length, targetDimensions.width, targetDimensions.thickness);
            
            if (candidateBlock) {
                maxDim = Math.max(maxDim, candidateBlock.length, candidateBlock.width, candidateBlock.thickness);
            }
            
            const scale = Math.min(200 / maxDim, 1.5);
            
            const sceneDiv = document.createElement('div');
            sceneDiv.className = 'combined-scene';
            
            const containerDiv = document.createElement('div');
            containerDiv.className = 'combined-box-container';
            containerDiv.id = 'combinedBoxContainer';
            
            // Cr√©er le bloc cible avec positionnement d'ancrage commun adapt√© √† la fen√™tre
            const targetBox = createBlock3D(targetDimensions, scale, 'target', 'Cible');
            
            // Position d'ancrage adapt√©e : ajuster selon la taille de la fen√™tre de visualisation
            // D√©caler pour que l'ancrage commun soit bien visible et centr√©
            const baseOffsetX = -80; // D√©calage de base vers la gauche
            const baseOffsetY = 20;  // D√©calage de base vers le bas
            
            const targetOffsetX = baseOffsetX + (targetDimensions.length * scale) / 2;
            const targetOffsetY = baseOffsetY - (targetDimensions.thickness * scale) / 2;
            const targetOffsetZ = (targetDimensions.width * scale) / 2;
            
            targetBox.style.transform = `translate(calc(-50% + ${targetOffsetX}px), calc(-50% + ${targetOffsetY}px)) translateZ(${targetOffsetZ}px)`;
            containerDiv.appendChild(targetBox);
            
            // Cr√©er le bloc candidat avec le m√™me point d'ancrage
            if (candidateBlock) {
                const candidateBox = createBlock3D(candidateBlock, scale, 'candidate', candidateBlock.ref);
                
                // M√™me position d'ancrage que le bloc cible
                const candidateOffsetX = baseOffsetX + (candidateBlock.length * scale) / 2;
                const candidateOffsetY = baseOffsetY - (candidateBlock.thickness * scale) / 2;
                const candidateOffsetZ = (candidateBlock.width * scale) / 2;
                
                candidateBox.style.transform = `translate(calc(-50% + ${candidateOffsetX}px), calc(-50% + ${candidateOffsetY}px)) translateZ(${candidateOffsetZ}px)`;
                containerDiv.appendChild(candidateBox);
            }
            
            sceneDiv.appendChild(containerDiv);
            container.appendChild(sceneDiv);
            
            const tooltip = document.createElement('div');
            tooltip.className = 'dimension-tooltip';
            tooltip.id = 'dimensionTooltip';
            document.body.appendChild(tooltip);
            
            const infoDiv = document.createElement('div');
            infoDiv.className = 'dimensions-info';
            
            const targetInfo = document.createElement('div');
            targetInfo.className = 'dimension-item target';
            targetInfo.innerHTML = `
                <strong>Cible</strong><br>
                ${targetDimensions.length} √ó ${targetDimensions.width} √ó ${targetDimensions.thickness} mm<br>
                <small>${(targetDimensions.length * targetDimensions.width * targetDimensions.thickness).toLocaleString()} mm¬≥</small>
            `;
            infoDiv.appendChild(targetInfo);
            
            if (candidateBlock) {
                const candidateInfo = document.createElement('div');
                candidateInfo.className = 'dimension-item candidate';
                candidateInfo.innerHTML = `
                    <strong>Candidat</strong><br>
                    ${candidateBlock.length} √ó ${candidateBlock.width} √ó ${candidateBlock.thickness} mm<br>
                    <small>${(candidateBlock.length * candidateBlock.width * candidateBlock.thickness).toLocaleString()} mm¬≥</small>
                `;
                infoDiv.appendChild(candidateInfo);
            }
            
            container.appendChild(infoDiv);
            
            document.getElementById('rotationControls').style.display = 'block';
            document.getElementById('vizLegend').style.display = 'block';
            
            changeView('perspective');
        }

        function createBlock3D(dimensions, scale, type, label) {
            const length = dimensions.length * scale;
            const width = dimensions.width * scale;
            const thickness = dimensions.thickness * scale;
            
            const boxDiv = document.createElement('div');
            boxDiv.className = 'block-box';
            boxDiv.style.cssText = `
                transform: translate(20%, -60%) translateZ(-${Math.max(length, width, thickness) / 2}px);
            `;
            
            // D√©finir les faces avec les vraies dimensions et mesures interactives
            const faces = [
                {
                    name: 'front',
                    width: length,
                    height: thickness,
                    transform: `translateZ(${width / 2}px)`,
                    content: type === 'target' ? label : '',
                    dimension: `${dimensions.length} √ó ${dimensions.thickness}`,
                    description: 'Face avant (Longueur √ó √âpaisseur)'
                },
                {
                    name: 'back',
                    width: length,
                    height: thickness,
                    transform: `rotateY(180deg) translateZ(${width / 2}px)`,
                    content: '',
                    dimension: `${dimensions.length} √ó ${dimensions.thickness}`,
                    description: 'Face arri√®re (Longueur √ó √âpaisseur)'
                },
                {
                    name: 'right',
                    width: width,
                    height: thickness,
                    transform: `rotateY(90deg) translateZ(${length / 2}px)`,
                    content: '',
                    dimension: `${dimensions.width} √ó ${dimensions.thickness}`,
                    description: 'Face droite (Largeur √ó √âpaisseur)'
                },
                {
                    name: 'left',
                    width: width,
                    height: thickness,
                    transform: `rotateY(-90deg) translateZ(${length / 2}px)`,
                    content: '',
                    dimension: `${dimensions.width} √ó ${dimensions.thickness}`,
                    description: 'Face gauche (Largeur √ó √âpaisseur)'
                },
                {
                    name: 'top',
                    width: length,
                    height: width,
                    transform: `rotateX(90deg) translateZ(${thickness / 2}px)`,
                    content: '',
                    dimension: `${dimensions.length} √ó ${dimensions.width}`,
                    description: 'Face sup√©rieure (Longueur √ó Largeur)'
                },
                {
                    name: 'bottom',
                    width: length,
                    height: width,
                    transform: `rotateX(-90deg) translateZ(${thickness / 2}px)`,
                    content: '',
                    dimension: `${dimensions.length} √ó ${dimensions.width}`,
                    description: 'Face inf√©rieure (Longueur √ó Largeur)'
                }
            ];
            
            faces.forEach(face => {
                const faceDiv = document.createElement('div');
                faceDiv.className = `block-face ${type}-face`;
                faceDiv.style.cssText = `
                    width: ${face.width}px;
                    height: ${face.height}px;
                    transform: ${face.transform};
                    left: -${face.width / 2}px;
                    top: -${face.height / 2}px;
                `;
                
                if (face.content) {
                    faceDiv.textContent = face.content;
                }
                
                faceDiv.addEventListener('mouseenter', (e) => {
                    showDimensionTooltip(e, face.dimension, face.description, type);
                });
                
                faceDiv.addEventListener('mouseleave', () => {
                    hideDimensionTooltip();
                });
                
                faceDiv.addEventListener('mousemove', (e) => {
                    updateTooltipPosition(e);
                });
                
                boxDiv.appendChild(faceDiv);
            });
            
            return boxDiv;
        }

        function showDimensionTooltip(event, dimension, description, type) {
            const tooltip = document.getElementById('dimensionTooltip');
            if (!tooltip) return;
            
            const typeLabel = type === 'target' ? 'Cible' : 'Candidat';
            const surplus = calculateSurplus(dimension, type);
            
            tooltip.innerHTML = `
                <strong>${typeLabel}</strong><br>
                ${description}<br>
                <strong>${dimension} mm</strong>
                ${surplus ? `<br><small style="color: #fdcb6e;">+${surplus}</small>` : ''}
            `;
            
            tooltip.classList.add('show');
            updateTooltipPosition(event);
        }

        function hideDimensionTooltip() {
            const tooltip = document.getElementById('dimensionTooltip');
            if (tooltip) {
                tooltip.classList.remove('show');
            }
        }

        function updateTooltipPosition(event) {
            const tooltip = document.getElementById('dimensionTooltip');
            if (!tooltip) return;
            
            tooltip.style.left = (event.pageX + 10) + 'px';
            tooltip.style.top = (event.pageY - 10) + 'px';
        }

        function calculateSurplus(dimension, type) {
            if (type !== 'candidate' || !currentTargetDimensions || !currentCandidateBlock) {
                return null;
            }
            
            const candidateDims = `${currentCandidateBlock.length} √ó ${currentCandidateBlock.width}`;
            const targetDims = `${currentTargetDimensions.length} √ó ${currentTargetDimensions.width}`;
            
            if (dimension.includes('√ó')) {
                const parts = dimension.split(' √ó ');
                const dim1 = parseInt(parts[0]);
                const dim2 = parseInt(parts[1]);
                
                if (candidateDims.includes(dim1.toString()) && candidateDims.includes(dim2.toString())) {
                    const targetParts = targetDims.split(' √ó ');
                    const targetDim1 = parseInt(targetParts[0]);
                    const targetDim2 = parseInt(targetParts[1]);
                    
                    const surplus1 = dim1 - targetDim1;
                    const surplus2 = dim2 - targetDim2;
                    
                    if (surplus1 > 0 || surplus2 > 0) {
                        return `${surplus1}√ó${surplus2}mm surplus`;
                    }
                }
            }
            
            return null;
        }

        function changeView(view) {
            const container = document.getElementById('combinedBoxContainer');
            if (!container) return;
            
            container.classList.remove('show-front', 'show-right', 'show-top', 'show-perspective');
            
            switch(view) {
                case 'front':
                    container.style.transform = 'rotateX(0deg) rotateY(0deg)';
                    break;
                case 'right':
                    container.style.transform = 'rotateX(0deg) rotateY(-90deg)';
                    break;
                case 'top':
                    container.style.transform = 'rotateX(-90deg) rotateY(0deg)';
                    break;
                case 'perspective':
                default:
                    container.style.transform = 'rotateX(-15deg) rotateY(25deg)';
                    break;
            }
        }

        function displayCandidatesList(candidates, criteria) {
            const container = document.getElementById('candidatesList');
            if (!container) return;

            container.innerHTML = '';

            const headerDiv = document.createElement('div');
            headerDiv.style.cssText = 'background: #e8f4f8; padding: 10px; border-radius: 6px; margin-bottom: 15px; text-align: center; border: 1px solid #74b9ff;';
            headerDiv.innerHTML = '<small style="color: #0984e3; font-weight: 600;">üí° Cliquez sur un candidat pour voir ses d√©tails de d√©coupe</small>';
            container.appendChild(headerDiv);

            candidates.slice(0, 8).forEach((candidate, index) => {
                const item = document.createElement('div');
                item.className = 'candidate-item';
                
                if (index === selectedCandidateIndex) {
                    item.classList.add('selected');
                }

                if (index === 0) {
                    item.classList.add('best');
                }

                let scoreClass = 'score-good';
                let scoreText = 'CORRECT';

                if (index === 0) {
                    scoreClass = 'score-best';
                    scoreText = 'OPTIMAL';
                }

                const analysis = candidate.analysis;
                const block = candidate.block;

                let criteriaInfo = `D√©coupes: ${analysis.cuts}`;
                
                if (criteria === 'minWaste') {
                    criteriaInfo += ` | Chutes: ${analysis.wasteVolume.toLocaleString()} mm¬≥ (${analysis.wastePercent.toFixed(1)}%)`;
                } else if (criteria === 'minCuts') {
                    criteriaInfo += ` | Chutes: ${analysis.wasteVolume.toLocaleString()} mm¬≥`;
                }

                const piecesInfo = analysis.totalPieces > 1 ? 
                    `<strong style="color: #00b894;">üéØ ${analysis.totalPieces} pi√®ces</strong> (${analysis.arrangement})<br>` : 
                    `<strong>üéØ 1 pi√®ce</strong><br>`;

                const familyClass = familyColors[block.family] || 'family-divers';

                item.innerHTML = `
                    <div class="candidate-header">
                        <span class="candidate-ref">#${index + 1} - ${block.ref}</span>
                        <span class="candidate-score ${scoreClass}">${scoreText}</span>
                    </div>
                    <div class="candidate-details">
                        <span class="family-cell ${familyClass}" style="display: inline-block; margin-bottom: 5px;">${block.family}</span><br>
                        <strong>Dim:</strong> ${block.length}√ó${block.width}√ó${block.thickness}mm | <strong>Stock:</strong> ${block.quantity}<br>
                        ${piecesInfo}
                        <strong style="color: #e17055;">${criteriaInfo}</strong><br>
                        <strong>Efficacit√©:</strong> ${analysis.efficiency.toFixed(1)}%
                    </div>
                `;

                item.addEventListener('click', () => {
                    selectCandidate(index);
                });

                if (index === selectedCandidateIndex) {
                    const selectedIndicator = document.createElement('div');
                    selectedIndicator.style.cssText = 'position: absolute; top: 5px; right: 5px; background: #e17055; color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 600;';
                    selectedIndicator.textContent = '‚úì';
                    item.style.position = 'relative';
                    item.appendChild(selectedIndicator);
                }

                container.appendChild(item);
            });

            if (candidates.length > 8) {
                const moreInfo = document.createElement('div');
                moreInfo.style.cssText = 'text-align: center; padding: 10px; color: #7f8c8d; font-style: italic;';
                moreInfo.textContent = `... et ${candidates.length - 8} autre(s) candidat(s)`;
                container.appendChild(moreInfo);
            }

            const noteDiv = document.createElement('div');
            noteDiv.style.cssText = 'background: #fff3cd; padding: 8px; border-radius: 6px; margin-top: 10px; text-align: center; border: 1px solid #ffc107;';
            noteDiv.innerHTML = '<small style="color: #856404;">‚ÑπÔ∏è Le candidat s√©lectionn√© appara√Æt dans "Bloc choisi" et "D√©coupes √† r√©aliser"</small>';
            container.appendChild(noteDiv);
        }

        function exportToPDF() {
            if (!optimizationResult || !optimizationResult.candidates || optimizationResult.candidates.length === 0) {
                alert('Aucun r√©sultat √† exporter !');
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const selectedCandidate = optimizationResult.candidates[selectedCandidateIndex];
            const targetL = parseInt(document.getElementById('targetLength').value);
            const targetW = parseInt(document.getElementById('targetWidth').value);
            const targetT = parseInt(document.getElementById('targetThickness').value);
            const selectedFamily = document.getElementById('familyFilter').value;
            
            doc.setFontSize(18);
            doc.setFont(undefined, 'bold');
            doc.text('FICHE DE D√âCOUPE - BE FOURS', 20, 20);
            
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text(`G√©n√©r√©e le: ${new Date().toLocaleDateString('fr-FR')} √† ${new Date().toLocaleTimeString('fr-FR')}`, 20, 30);
            
            if (selectedFamily !== 'all') {
                doc.text(`Famille de mat√©riaux: ${selectedFamily}`, 20, 40);
            }
            
            if (selectedCandidateIndex === 0) {
                doc.text('CANDIDAT OPTIMAL S√âLECTIONN√â', 20, 50);
            } else {
                doc.text(`CANDIDAT S√âLECTIONN√â (Rang #${selectedCandidateIndex + 1})`, 20, 50);
            }
            
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text('BLOC S√âLECTIONN√â', 20, 65);
            
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text(`R√©f√©rence: ${selectedCandidate.block.ref}`, 20, 75);
            doc.text(`Famille: ${selectedCandidate.block.family}`, 20, 85);
            doc.text(`Dimensions originales: ${selectedCandidate.block.length} √ó ${selectedCandidate.block.width} √ó ${selectedCandidate.block.thickness} mm`, 20, 95);
            doc.text(`Stock disponible: ${selectedCandidate.block.quantity} unit√©(s)`, 20, 105);
            
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text('OBJECTIF PRODUCTION', 20, 120);
            
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text(`Dimensions cibles: ${targetL} √ó ${targetW} √ó ${targetT} mm`, 20, 130);
            doc.text(`Nombre de pi√®ces: ${selectedCandidate.analysis.totalPieces}`, 20, 140);
            doc.text(`Arrangement: ${selectedCandidate.analysis.arrangement}`, 20, 150);
            doc.text(`Efficacit√© d√©coupe: ${selectedCandidate.analysis.efficiency.toFixed(1)}%`, 20, 160);
            
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text('R√âSUM√â D√âCOUPE', 20, 175);
            
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text(`Volume bloc original: ${(selectedCandidate.block.length * selectedCandidate.block.width * selectedCandidate.block.thickness).toLocaleString()} mm¬≥`, 20, 185);
            doc.text(`Volume utile produit: ${selectedCandidate.analysis.usedVolume.toLocaleString()} mm¬≥`, 20, 195);
            doc.text(`Volume de chutes: ${selectedCandidate.analysis.wasteVolume.toLocaleString()} mm¬≥`, 20, 205);
            doc.text(`Pourcentage chutes: ${selectedCandidate.analysis.wastePercent.toFixed(1)}%`, 20, 215);
            doc.text(`Nombre total de d√©coupes: ${selectedCandidate.analysis.cuts}`, 20, 225);
            
            if (optimizationResult.candidates.length > 1) {
                doc.text('AUTRES CANDIDATS DISPONIBLES:', 20, 240);
                let yPos = 250;
                optimizationResult.candidates.slice(0, 5).forEach((candidate, index) => {
                    if (index !== selectedCandidateIndex) {
                        const status = index === 0 ? '(OPTIMAL)' : `(Rang #${index + 1})`;
                        doc.text(`‚Ä¢ ${candidate.block.ref} ${status} - ${candidate.block.family} - Efficacit√©: ${candidate.analysis.efficiency.toFixed(1)}%`, 25, yPos);
                        yPos += 10;
                    }
                });
            }
            
            const fileName = `Fiche_Decoupe_BEFours_${selectedCandidate.block.ref}_${targetL}x${targetW}x${targetT}.pdf`;
            doc.save(fileName);
        }

        // Initialisation
        document.addEventListener('DOMContentLoaded', function () {
            console.log('üöÄ Optimisateur de D√©coupe - BE Fours');
            console.log('‚úÖ Support du format Inventaire BE Fours');
            console.log('‚úÖ Filtrage par famille de mat√©riaux r√©fractaires');
            console.log('‚úÖ 8 familles d√©tect√©es automatiquement');
            console.log('‚úÖ Interface adapt√©e aux mat√©riaux industriels');
            console.log('‚úÖ Visualisation 3D avec proportions r√©elles');

            const fileInput = document.getElementById('excelFileInput');
            if (fileInput) {
                fileInput.addEventListener('change', handleExcelFile);
            }

            const rotationControls = document.querySelector('.rotation-buttons');
            if (rotationControls) {
                rotationControls.addEventListener('change', function(event) {
                    if (event.target.name === 'rotate-view') {
                        changeView(event.target.value);
                    }
                });
            }

            window.addEventListener('scroll', hideDimensionTooltip);
            window.addEventListener('resize', hideDimensionTooltip);
        });
    </script>
</body>

</html>
                    